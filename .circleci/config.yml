version: 2
jobs:
  build:
    working_directory: /app
    docker:
      - image: php:7.1-apache
        environment:
          APP_ENV: test
    steps:
       - checkout
       - run:
          name: Install system packages
          command: apt-get update && apt-get -y install zip git zlib1g-dev wget
       - run:
          name: Install PHP extensions
          command: |
            docker-php-ext-install pdo
            docker-php-ext-install zip
       - run:
          name: Display PHP information
          command: |
            php -v
       - run:
          name: Check PHP sintax
          command: find . -name \*.php -exec php -l "{}" \;
       - persist_to_workspace:
          root: /
          paths:
            - app

  publish:
    working_directory: /
    docker:
      - image: docker:17.05.0-ce-git
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: /
      - run:
          name: Copy CI files to root
          command: |
             cd /app
             cp .circleci/data/Dockerfile .
             cp .circleci/data/wait-for-mysql.sh .
      - run:
          name: Build image base for modifications
          command: |
             cd /app
             docker build -t ${DOCKER_ACCOUNT}/${PROJECT_NAME}:latest .
             docker run --name newimage -d -p3306:3306 -p80:80 ${DOCKER_ACCOUNT}/${PROJECT_NAME}:latest
             docker exec -it newimage ls
      - run:
          name: Activate and setup Plugin
          command: |
            docker exec -it newimage sh -c "cd /var/www/html && composer require mundipagg/mundipagg-magento2-module -vvv"
            docker exec -it newimage sh -c "cd /var/www/html && composer update -vvv"
            docker exec -it newimage sh -c "cd /var/www/ && find html/ -type d -exec chmod 775 {} \;"
            docker exec -it newimage sh -c "cd /var/www/ && find html/ -type f -exec chmod 664 {} \;"
            docker exec -it newimage sh -c "cd /var/www/ && chown -R www-data:www-data html/"
            docker exec -it newimage sh -c "cd /var/www/html && php bin/magento setup:upgrade"
            docker exec -it newimage sh -c "cd /var/www/html && php bin/magento setup:di:compile"
            docker exec -it newimage php index.php
            docker exec -it newimage mysql magento2 -e \
            "update core_config_data set value = '${STG_URL}' where path = 'web/unsecure/base_url';"
            docker exec -it newimage mysql magento2 -e \
                        "insert into core_config_data (scope, scope_id, path, value) \
                        values ('default', 0, 'web/secure/base_url', '${STG_URL}');"
            docker exec -it newimage mysql magento2 -e \
              "update magento2.core_config_data set value = '1' \
              where path like 'customer/create_account/vat_frontend_visibility';"
            docker exec -it newimage mysql magento2 -e \
            "INSERT INTO magento2.core_config_data VALUES (null, 'default', 0, 'customer/address/taxvat_show', null)"

            docker exec -it newimage mysql magento2 -e \
            "INSERT INTO magento2.core_config_data (scope, scope_id, path, value) \
            VALUES ('default', 0, 'mundipagg_mundipagg/global/test_mode', '1'), \
            ('default', 0, 'mundipagg_mundipagg/global/secret_key_test', '${API_TEST_SECRET_KEY}'), \
            ('default', 0, 'mundipagg_mundipagg/global/public_key_test', '${API_TEST_PUBLIC_KEY}'), \
            ('default', 0, 'payment/mundipagg_customer_address/street_attribute', 'street_1'), \
            ('default', 0, 'payment/mundipagg_customer_address/number_attribute', 'street_2'), \
            ('default', 0, 'payment/mundipagg_customer_address/complement_attribute', 'street_3'), \
            ('default', 0, 'payment/mundipagg_customer_address/district_attribute', 'street_4'), \
            ('default', 0, 'payment/mundipagg_creditcard/active', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/title', 'MundiPagg Cartao'), \
            ('default', 0, 'payment/mundipagg_creditcard/soft_description', 'Loja Magento 2 stg'), \
            ('default', 0, 'payment/mundipagg_creditcard/payment_action', 'authorize_capture'), \
            ('default', 0, 'payment/mundipagg_creditcard/sort_order', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/cctypes', 'Visa,Mastercard,Amex,Hipercard,Diners,Elo,Discover,Aura'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_active', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_type', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_number', '12'), \
            ('default', 0, 'payment/mundipagg_creditcard/installment_min_amount', '10.00'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_interest_by_issuer', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_interest_rate_initial', '10'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_interest_rate_incremental', '1'), \
            ('default', 0, 'payment/mundipagg_creditcard/installments_max_without_interest', '6'), \
            ('default', 0, 'payment/mundipagg_creditcard/antifraud_active', '0'), \
            ('default', 0, 'payment/mundipagg_billet/active', '1'), \
            ('default', 0, 'payment/mundipagg_billet/title', 'MundiPagg Boleto'), \
            ('default', 0, 'payment/mundipagg_billet/text', 'Voce podera imprimir seu boleto apos finalizar a compra'), \
            ('default', 0, 'payment/mundipagg_billet/types', 'Itau'), \
            ('default', 0, 'payment/mundipagg_billet/instructions', 'Pagar ate o vencimento'), \
            ('default', 0, 'payment/mundipagg_billet/expiration_days', '5'), \
            ('default', 0, 'payment/mundipagg_billet/sort_order', '1'), \
            ('default', 0, 'payment/mundipagg_two_creditcard/active', '1'), \
            ('default', 0, 'payment/mundipagg_two_creditcard/title', 'MundiPagg 2 cartoes'), \
            ('default', 0, 'payment/mundipagg_two_creditcard/sort_order', '1'), \
            ('default', 0, 'payment/mundipagg_billet_creditcard/active', '1'), \
            ('default', 0, 'payment/mundipagg_billet_creditcard/title', 'MundiPagg Boleto e Cartao'), \
            ('default', 0, 'payment/mundipagg_billet_creditcard/sort_order', '1'), \
            ('default', 0, 'payment/mundipagg_multibuyer/active', '1');"
            docker exec -it newimage sh -c "cd /var/www/html && php bin/magento cache:flush"
            docker exec -it newimage sh -c "cd /var/www/html && php bin/magento setup:di:compile"
      - run:
          name: Clear useless files
          command: |
            pwd
      - deploy:
          name: Commit and push Docker image
          command: |
             sleep 5 && docker stop newimage
             docker login ${DOCKER_ACCOUNT} -u ${DOCKER_USER} -p ${DOCKER_PASS}
             docker commit newimage ${DOCKER_ACCOUNT}/${PROJECT_NAME}:latest
             docker tag ${DOCKER_ACCOUNT}/${PROJECT_NAME} "${DOCKER_ACCOUNT}/${PROJECT_NAME}:latest"
             docker tag ${DOCKER_ACCOUNT}/${PROJECT_NAME} "${DOCKER_ACCOUNT}/${PROJECT_NAME}:${CIRCLE_BRANCH}"
             docker tag ${DOCKER_ACCOUNT}/${PROJECT_NAME} "${DOCKER_ACCOUNT}/${PROJECT_NAME}:${CIRCLE_SHA1:0:8}"
             docker push "${DOCKER_ACCOUNT}/${PROJECT_NAME}"
  deploy_staging:
     machine: true
     steps:
       - run:
           name: Send deployment webhook to Rancher
           command: |
             BODY='{"push_data":{"tag":"'"${CIRCLE_BRANCH}"'"},"repository":{"repo_name":"'"${DOCKER_ACCOUNT}/${PROJECT_NAME}"'"}}'
             curl -X POST ${RANCHER_STG_DEPLOY_URL} -H 'Content-Type: application/json' -d "${BODY}"

workflows:
  version: 2
  build_publish_deploy:
    jobs:
      - build
      - publish:
          requires:
            - build
      - deploy_staging:
          requires:
            - publish
          filters:
            branches:
              only: master
